name: Rename Flutter App

on:
  workflow_dispatch:
    inputs:
      app_name:
        description: 'App Display Name'
        required: true
        type: string
      package_name:
        description: 'Package/Bundle ID'
        required: true
        type: string
  push:
    branches:
      - main

jobs:
  rename-app:
    runs-on: ubuntu-latest
    # Only run if this is NOT the boilerplate repo AND the app hasn't been renamed yet
    if: |
      github.repository != 'Devweave/flutter-boilerplate' && 
      (contains(github.event.head_commit.message, 'Initial commit') || 
       github.event_name == 'workflow_dispatch')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if app already renamed
        id: check-renamed
        run: |
          # Check if pubspec.yaml still contains boilerplate name
          if grep -q "name: flutter_boilerplate" pubspec.yaml; then
            echo "renamed=false" >> $GITHUB_OUTPUT
          else
            echo "renamed=true" >> $GITHUB_OUTPUT
          fi

      - name: Get app name and package from repository variables
        if: steps.check-renamed.outputs.renamed == 'false'
        id: get-params
        run: |
          # Use repository variables set by Backstage, fallback to workflow inputs
          APP_NAME="${{ github.event.inputs.app_name || vars.FLUTTER_APP_NAME || 'My Flutter App' }}"
          PACKAGE_NAME="${{ github.event.inputs.package_name || vars.FLUTTER_PACKAGE_NAME || 'com.example.myapp' }}"
          
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT
          echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          
          echo "Using App Name: $APP_NAME"
          echo "Using Package Name: $PACKAGE_NAME"

      - name: Setup Dart
        if: steps.check-renamed.outputs.renamed == 'false'
        uses: dart-lang/setup-dart@v1

      - name: Install FVM
        if: steps.check-renamed.outputs.renamed == 'false'
        run: dart pub global activate fvm

      - name: Read Flutter version from .fvmrc
        if: steps.check-renamed.outputs.renamed == 'false'
        id: flutter-version
        run: |
          if [ -f .fvmrc ]; then
            VERSION=$(cat .fvmrc | jq -r '.flutter' 2>/dev/null || cat .fvmrc)
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          else
            echo "version=stable" >> $GITHUB_OUTPUT
          fi

      - name: Install Flutter version with FVM
        if: steps.check-renamed.outputs.renamed == 'false'
        run: |
          fvm install ${{ steps.flutter-version.outputs.version }}
          fvm use ${{ steps.flutter-version.outputs.version }} --force

      - name: Add FVM to PATH
        if: steps.check-renamed.outputs.renamed == 'false'
        run: echo "$HOME/fvm/versions/${{ steps.flutter-version.outputs.version }}/bin" >> $GITHUB_PATH

      - name: Verify Flutter installation
        if: steps.check-renamed.outputs.renamed == 'false'
        run: fvm flutter --version

      - name: Install Flutter Rename Package
        if: steps.check-renamed.outputs.renamed == 'false'
        run: fvm flutter pub global activate rename

      - name: Rename App Display Name
        if: steps.check-renamed.outputs.renamed == 'false'
        run: |
          fvm flutter pub global run rename --appname "${{ steps.get-params.outputs.app_name }}"
        
      - name: Set Package/Bundle ID
        if: steps.check-renamed.outputs.renamed == 'false'
        run: |
          fvm flutter pub global run rename --bundleId "${{ steps.get-params.outputs.package_name }}"

      - name: Commit and push changes
        if: steps.check-renamed.outputs.renamed == 'false'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Check if there are any changes
          if [[ -n $(git status --porcelain) ]]; then
            git add .
            git commit -m "chore: rename Flutter app to '${{ steps.get-params.outputs.app_name }}' with package '${{ steps.get-params.outputs.package_name }}'"
            git push
          else
            echo "No changes to commit"
          fi

      - name: Remove this workflow after successful rename
        if: steps.check-renamed.outputs.renamed == 'false'
        run: |
          git rm .github/workflows/rename-flutter-app.yml
          git commit -m "chore: remove rename workflow after completion"
          git push

      - name: Skip - App already renamed
        if: steps.check-renamed.outputs.renamed == 'true'
        run: |
          echo "App has already been renamed. Skipping rename process."
          echo "If you need to rename again, use workflow_dispatch with manual inputs."